// Export surprise test results to Excel
app.get('/api/admin/export-surprise-test', async (req, res) => {
    try {
        const results = readJSONFile(RESULTS_FILE) || [];
        const subjects = readJSONFile(SUBJECTS_FILE) || [];
        
        // Filter only surprise test results
        const surpriseSubject = subjects.find(s => s.isSurpriseTest);
        if (!surpriseSubject) {
            return res.status(404).json({ error: 'Surprise test subject not found' });
        }
        
        const surpriseResults = results.filter(r => r.subjectId === surpriseSubject.id);
        
        if (surpriseResults.length === 0) {
            return res.status(404).json({ error: 'No surprise test results found' });
        }
        
        // Create Excel workbook
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Surprise Test Results');
        
        // Add headers
        worksheet.columns = [
            { header: 'Student ID', key: 'studentId', width: 15 },
            { header: 'Name', key: 'name', width: 25 },
            { header: 'Email', key: 'email', width: 30 },
            { header: 'Mobile', key: 'mobile', width: 15 },
            { header: 'Score', key: 'score', width: 12 },
            { header: 'Percentage', key: 'percentage', width: 12 },
            { header: 'Exam Date', key: 'examDate', width: 20 }
        ];
        
        // Style header row
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF4472C4' }
        };
        worksheet.getRow(1).font = { color: { argb: 'FFFFFFFF' }, bold: true };
        
        // Add data rows
        surpriseResults.forEach(result => {
            worksheet.addRow({
                studentId: result.studentId,
                name: result.studentName,
                email: result.studentEmail || 'N/A',
                mobile: result.studentMobile || 'N/A',
                score: `${result.obtainedMarks}/${result.totalMarks}`,
                percentage: `${result.percentage}%`,
                examDate: new Date(result.timestamp).toLocaleString()
            });
        });
        
        // Set response headers
        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        res.setHeader('Content-Disposition', `attachment; filename=Surprise_Test_Results_${Date.now()}.xlsx`);
        
        // Write to response
        await workbook.xlsx.write(res);
        res.end();
        
    } catch (error) {
        console.error('Excel export error:', error);
        res.status(500).json({ error: 'Failed to export results: ' + error.message });
    }
});

